<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lauternopoly - Das Kaiserslautern Monopoly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        #gameContainer {
            max-width: 100vw;
            margin: 0 auto;
            padding: 10px;
        }

        #board {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1;
            margin: 0 auto 20px;
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 1px;
            background: #2c3e50;
            border: 3px solid #34495e;
            border-radius: 10px;
            position: relative;
        }

        .field {
            background: #ecf0f1;
            border: 1px solid #34495e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2px;
            font-size: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .field:hover {
            background: #d5dbdd;
            transform: scale(1.05);
            z-index: 10;
        }

        .corner {
            grid-column: span 2;
            grid-row: span 2;
            font-size: 0.7rem;
            font-weight: bold;
            background: #3498db;
            color: white;
        }

        .property-color {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20%;
            background: #e74c3c;
        }

        .property-brown { background: #8B4513 !important; }
        .property-lightblue { background: #87CEEB !important; }
        .property-pink { background: #FF69B4 !important; }
        .property-orange { background: #FFA500 !important; }
        .property-red { background: #DC143C !important; }
        .property-yellow { background: #FFD700 !important; }
        .property-green { background: #228B22 !important; }
        .property-blue { background: #0000CD !important; }

        .field-name {
            font-weight: bold;
            margin-top: 15%;
            font-size: 0.6rem;
        }

        .field-price {
            font-size: 0.5rem;
            color: #2c3e50;
        }

        .station {
            background: #34495e;
            color: white;
        }

        .utility {
            background: #95a5a6;
            color: white;
        }

        #controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .player-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .player-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .player-card.active {
            animation: pulse 1s infinite;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .player-card h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-token {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-block;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        #dice {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .die {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #34495e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
            animation: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .die.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(360deg) scale(1.2); }
            100% { transform: rotate(720deg) scale(1); }
        }

        #gameLog {
            background: white;
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .property-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .property-item {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .property-item:hover {
            background: #d5dbdd;
            transform: translateX(5px);
        }

        .property-item.selected {
            background: #3498db;
            color: white;
        }

        .trade-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .trade-column {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
        }

        .trade-column h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }

        .houses-container {
            position: absolute;
            top: 2px;
            right: 2px;
            display: flex;
            gap: 1px;
        }

        .house {
            width: 8px;
            height: 8px;
            background: #27ae60;
            border: 1px solid #229954;
        }

        .hotel {
            width: 10px;
            height: 10px;
            background: #e74c3c;
            border: 1px solid #c0392b;
        }

        .player-piece {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 5;
            transition: all 0.5s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #setupModal {
            display: flex;
        }

        .player-setup {
            margin: 15px 0;
        }

        .player-setup input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #2c3e50;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .field {
                font-size: 0.4rem;
            }
            
            .field-name {
                font-size: 0.5rem;
            }
            
            .corner {
                font-size: 0.6rem;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .player-info {
                grid-template-columns: 1fr;
            }
        }

        .chance-card {
            background: #e67e22;
            color: white;
        }

        .community-chest {
            background: #3498db;
            color: white;
        }

        #startScreen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 4px 30px rgba(0,0,0,0.2);
        }

        #startScreen h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }

        #startScreen p {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        #propertyCard {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 250px;
        }

        #propertyCard.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .property-card-header {
            padding: 10px;
            margin: -15px -15px 10px -15px;
            border-radius: 10px 10px 0 0;
            color: white;
            font-weight: bold;
        }

        .property-details {
            font-size: 14px;
            line-height: 1.6;
        }

        .property-details div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen">
        <div class="logo">üèòÔ∏è</div>
        <h1>Lauternopoly</h1>
        <p>Das ultimative Kaiserslautern Monopoly-Spiel!</p>
        <button onclick="showSetupModal()">Neues Spiel starten</button>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Spieler einrichten</div>
            <div id="playerSetupContainer">
                <div class="player-setup">
                    <h4>Spieler 1</h4>
                    <input type="text" placeholder="Name eingeben" id="player1Name" value="Spieler 1">
                    <div class="color-picker">
                        <div class="color-option selected" style="background: #e74c3c" data-color="#e74c3c" data-player="1"></div>
                        <div class="color-option" style="background: #3498db" data-color="#3498db" data-player="1"></div>
                        <div class="color-option" style="background: #2ecc71" data-color="#2ecc71" data-player="1"></div>
                        <div class="color-option" style="background: #f39c12" data-color="#f39c12" data-player="1"></div>
                    </div>
                </div>
                <div class="player-setup">
                    <h4>Spieler 2</h4>
                    <input type="text" placeholder="Name eingeben" id="player2Name" value="Spieler 2">
                    <div class="color-picker">
                        <div class="color-option" style="background: #e74c3c" data-color="#e74c3c" data-player="2"></div>
                        <div class="color-option selected" style="background: #3498db" data-color="#3498db" data-player="2"></div>
                        <div class="color-option" style="background: #2ecc71" data-color="#2ecc71" data-player="2"></div>
                        <div class="color-option" style="background: #f39c12" data-color="#f39c12" data-player="2"></div>
                    </div>
                </div>
            </div>
            <button onclick="addPlayer()">+ Spieler hinzuf√ºgen</button>
            <button onclick="startGame()">Spiel starten</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" style="display: none;">
        <!-- Game Board -->
        <div id="board"></div>

        <!-- Property Card -->
        <div id="propertyCard">
            <div class="property-card-header" id="propertyCardHeader">Eigenschaft</div>
            <div class="property-details" id="propertyCardDetails"></div>
        </div>

        <!-- Controls -->
        <div id="controls">
            <div class="player-info" id="playerInfo"></div>
            
            <div id="dice">
                <div class="die" id="die1">‚öÄ</div>
                <div class="die" id="die2">‚öÄ</div>
            </div>

            <div class="action-buttons">
                <button onclick="rollDice()" id="rollButton">üé≤ W√ºrfeln</button>
                <button onclick="showBuyPropertyModal()" id="buyButton" style="display: none;">üè† Grundst√ºck kaufen</button>
                <button onclick="showTradeModal()">üí± Handeln</button>
                <button onclick="showPropertiesModal()">üìã Eigentum anzeigen</button>
                <button onclick="showBuildModal()">üèóÔ∏è H√§user bauen</button>
                <button onclick="endTurn()" id="endTurnButton" disabled>Zug beenden</button>
            </div>
        </div>

        <!-- Game Log -->
        <div id="gameLog">
            <div class="log-entry">Willkommen bei Lauternopoly!</div>
        </div>
    </div>

    <!-- Buy Property Modal -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Grundst√ºck kaufen</div>
            <div id="buyPropertyInfo"></div>
            <button onclick="buyProperty()">Kaufen</button>
            <button onclick="closeBuyModal()">Ablehnen</button>
        </div>
    </div>

    <!-- Properties Modal -->
    <div id="propertiesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Deine Grundst√ºcke</div>
            <div id="propertiesList"></div>
            <button onclick="closePropertiesModal()">Schlie√üen</button>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Handel</div>
            <div>
                <label>Mit wem m√∂chtest du handeln?</label>
                <select id="tradePartner"></select>
            </div>
            <div class="trade-section">
                <div class="trade-column">
                    <h4>Du bietest:</h4>
                    <div id="yourProperties"></div>
                    <input type="number" id="yourMoney" placeholder="Geldbetrag ‚Ç¨" min="0">
                </div>
                <div class="trade-column">
                    <h4>Du m√∂chtest:</h4>
                    <div id="theirProperties"></div>
                    <input type="number" id="theirMoney" placeholder="Geldbetrag ‚Ç¨" min="0">
                </div>
            </div>
            <button onclick="proposeTrade()">Handel vorschlagen</button>
            <button onclick="closeTradeModal()">Abbrechen</button>
        </div>
    </div>

    <!-- Build Modal -->
    <div id="buildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">H√§user & Hotels bauen</div>
            <div id="buildableProperties"></div>
            <button onclick="closeBuildModal()">Schlie√üen</button>
        </div>
    </div>

    <!-- Chance/Community Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="cardTitle">Ereigniskarte</div>
            <p id="cardText"></p>
            <button onclick="closeCardModal()">OK</button>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            players: [],
            currentPlayerIndex: 0,
            board: [],
            diceValues: [1, 1],
            hasRolled: false,
            properties: {},
            selectedTradeProperties: { yours: [], theirs: [] },
            playerCount: 2
        };

        // Board Fields Definition
        const boardFields = [
            // Bottom row (right to left)
            { name: "START", type: "corner", price: 0, position: 0 },
            { name: "Fackel-stra√üe", type: "property", color: "brown", price: 60, rent: 2, position: 1 },
            { name: "Gemein-schafts", type: "community", position: 2 },
            { name: "Rathaus-platz", type: "property", color: "brown", price: 60, rent: 4, position: 3 },
            { name: "Einkom-mens-steuer", type: "tax", price: 200, position: 4 },
            { name: "Haupt-bahnhof", type: "station", price: 200, rent: 25, position: 5 },
            { name: "Steinstra√üe", type: "property", color: "lightblue", price: 100, rent: 6, position: 6 },
            { name: "Ereignis", type: "chance", position: 7 },
            { name: "Markt-stra√üe", type: "property", color: "lightblue", price: 100, rent: 6, position: 8 },
            { name: "Lutrina-stra√üe", type: "property", color: "lightblue", price: 120, rent: 8, position: 9 },
            
            // Left column (bottom to top)
            { name: "Gef√§ngnis", type: "corner", position: 10 },
            { name: "Fruchthall-stra√üe", type: "property", color: "pink", price: 140, rent: 10, position: 11 },
            { name: "Strom-werk", type: "utility", price: 150, position: 12 },
            { name: "Schiller-platz", type: "property", color: "pink", price: 140, rent: 10, position: 13 },
            { name: "Bismarck-stra√üe", type: "property", color: "pink", price: 160, rent: 12, position: 14 },
            { name: "West-bahnhof", type: "station", price: 200, rent: 25, position: 15 },
            { name: "Union-stra√üe", type: "property", color: "orange", price: 180, rent: 14, position: 16 },
            { name: "Gemein-schafts", type: "community", position: 17 },
            { name: "Pariser Stra√üe", type: "property", color: "orange", price: 180, rent: 14, position: 18 },
            { name: "Spital-stra√üe", type: "property", color: "orange", price: 200, rent: 16, position: 19 },
            
            // Top row (left to right)
            { name: "Frei Parken", type: "corner", position: 20 },
            { name: "Pfaff-stra√üe", type: "property", color: "red", price: 220, rent: 18, position: 21 },
            { name: "Ereignis", type: "chance", position: 22 },
            { name: "Schneider-stra√üe", type: "property", color: "red", price: 220, rent: 18, position: 23 },
            { name: "M√ºhl-stra√üe", type: "property", color: "red", price: 240, rent: 20, position: 24 },
            { name: "Ost-bahnhof", type: "station", price: 200, rent: 25, position: 25 },
            { name: "Burgstra√üe", type: "property", color: "yellow", price: 260, rent: 22, position: 26 },
            { name: "Wasser-werk", type: "utility", price: 150, position: 27 },
            { name: "K√∂nigs-stra√üe", type: "property", color: "yellow", price: 260, rent: 22, position: 28 },
            { name: "Mall-platz", type: "property", color: "yellow", price: 280, rent: 24, position: 29 },
            
            // Right column (top to bottom)  
            { name: "Gehe ins Gef√§ngnis", type: "corner", position: 30 },
            { name: "FCK-Allee", type: "property", color: "green", price: 300, rent: 26, position: 31 },
            { name: "Garten-schau", type: "property", color: "green", price: 300, rent: 26, position: 32 },
            { name: "Gemein-schafts", type: "community", position: 33 },
            { name: "Betzen-berg", type: "property", color: "green", price: 320, rent: 28, position: 34 },
            { name: "S√ºd-bahnhof", type: "station", price: 200, rent: 25, position: 35 },
            { name: "Ereignis", type: "chance", position: 36 },
            { name: "TU Campus", type: "property", color: "blue", price: 350, rent: 35, position: 37 },
            { name: "Luxus-steuer", type: "tax", price: 100, position: 38 },
            { name: "PRE-Park", type: "property", color: "blue", price: 400, rent: 50, position: 39 }
        ];

        // Chance and Community Chest Cards
        const chanceCards = [
            { text: "Gehe zum FCK-Stadion! Ziehe vor zum Betzenberg.", action: "move", target: 34 },
            { text: "Die Stadt zahlt dir eine Pr√§mie von ‚Ç¨200!", action: "money", amount: 200 },
            { text: "Strafzettel! Zahle ‚Ç¨50 Bu√ügeld.", action: "money", amount: -50 },
            { text: "Gehe 3 Felder zur√ºck.", action: "moveRelative", amount: -3 },
            { text: "Du gewinnst im Lotto! Erhalte ‚Ç¨150.", action: "money", amount: 150 },
            { text: "Reparaturen: ‚Ç¨25 pro Haus, ‚Ç¨100 pro Hotel.", action: "repairs" },
            { text: "Gehe direkt ins Gef√§ngnis!", action: "jail" },
            { text: "Bankirrtum zu deinen Gunsten: ‚Ç¨200", action: "money", amount: 200 }
        ];

        const communityCards = [
            { text: "Geburtstag! Jeder Spieler schenkt dir ‚Ç¨10.", action: "birthday" },
            { text: "Arztkosten: Zahle ‚Ç¨50.", action: "money", amount: -50 },
            { text: "Versicherung zahlt aus: ‚Ç¨100", action: "money", amount: 100 },
            { text: "Schulgeld: Zahle ‚Ç¨50", action: "money", amount: -50 },
            { text: "Du erbst ‚Ç¨100", action: "money", amount: 100 },
            { text: "Steuernachzahlung: ‚Ç¨100", action: "money", amount: -100 },
            { text: "Sch√∂nheitswettbewerb gewonnen: ‚Ç¨10", action: "money", amount: 10 },
            { text: "Gehe zum Start!", action: "move", target: 0 }
        ];

        // Initialize game
        function initializeBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            // Create board layout
            for (let i = 0; i < 121; i++) {
                const field = document.createElement('div');
                field.style.display = 'none';
                board.appendChild(field);
            }

            // Place actual fields
            boardFields.forEach((fieldData, index) => {
                const field = createField(fieldData);
                let gridPosition = getGridPosition(index);
                
                board.children[gridPosition].replaceWith(field);
            });

            // Fill center with logo
            const centerField = document.createElement('div');
            centerField.style.gridColumn = '3 / 10';
            centerField.style.gridRow = '3 / 10';
            centerField.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            centerField.style.display = 'flex';
            centerField.style.alignItems = 'center';
            centerField.style.justifyContent = 'center';
            centerField.style.fontSize = '3rem';
            centerField.style.color = 'white';
            centerField.style.fontWeight = 'bold';
            centerField.style.borderRadius = '10px';
            centerField.innerHTML = 'üèòÔ∏è<br>LAUTERN<br>OPOLY';
            centerField.style.textAlign = 'center';
            centerField.style.lineHeight = '1';
            board.children[38].replaceWith(centerField);
        }

        function getGridPosition(index) {
            // Map board positions to grid positions
            if (index === 0) return 110; // Start
            if (index >= 1 && index <= 9) return 110 - index; // Bottom row
            if (index === 10) return 100; // Jail
            if (index >= 11 && index <= 19) return 100 - (index - 10) * 11; // Left column
            if (index === 20) return 0; // Free Parking
            if (index >= 21 && index <= 29) return index - 20; // Top row
            if (index === 30) return 10; // Go to Jail
            if (index >= 31 && index <= 39) return 10 + (index - 30) * 11; // Right column
            
            return 0;
        }

        function createField(fieldData) {
            const field = document.createElement('div');
            field.className = 'field';
            field.dataset.position = fieldData.position;
            field.dataset.type = fieldData.type;
            
            if (fieldData.type === 'corner') {
                field.className += ' corner';
                field.innerHTML = `<div>${fieldData.name}</div>`;
                
                // Style corners
                if (fieldData.position === 0) {
                    field.style.gridColumn = '10 / 12';
                    field.style.gridRow = '10 / 12';
                    field.style.background = '#2ecc71';
                } else if (fieldData.position === 10) {
                    field.style.gridColumn = '1 / 3';
                    field.style.gridRow = '10 / 12';
                    field.style.background = '#e67e22';
                } else if (fieldData.position === 20) {
                    field.style.gridColumn = '1 / 3';
                    field.style.gridRow = '1 / 3';
                    field.style.background = '#9b59b6';
                } else if (fieldData.position === 30) {
                    field.style.gridColumn = '10 / 12';
                    field.style.gridRow = '1 / 3';
                    field.style.background = '#c0392b';
                }
            } else {
                // Add property color bar
                if (fieldData.type === 'property') {
                    field.innerHTML = `
                        <div class="property-color property-${fieldData.color}"></div>
                        <div class="houses-container" id="houses-${fieldData.position}"></div>
                        <div class="field-name">${fieldData.name}</div>
                        <div class="field-price">‚Ç¨${fieldData.price}</div>
                    `;
                } else if (fieldData.type === 'station') {
                    field.className += ' station';
                    field.innerHTML = `
                        <div class="field-name">üöÇ<br>${fieldData.name}</div>
                        <div class="field-price">‚Ç¨${fieldData.price}</div>
                    `;
                } else if (fieldData.type === 'utility') {
                    field.className += ' utility';
                    const icon = fieldData.name.includes('Strom') ? '‚ö°' : 'üíß';
                    field.innerHTML = `
                        <div class="field-name">${icon}<br>${fieldData.name}</div>
                        <div class="field-price">‚Ç¨${fieldData.price}</div>
                    `;
                } else if (fieldData.type === 'chance') {
                    field.className += ' chance-card';
                    field.innerHTML = `<div class="field-name">‚ùì<br>${fieldData.name}</div>`;
                } else if (fieldData.type === 'community') {
                    field.className += ' community-chest';
                    field.innerHTML = `<div class="field-name">üì¶<br>${fieldData.name}</div>`;
                } else if (fieldData.type === 'tax') {
                    field.innerHTML = `
                        <div class="field-name">üí∞<br>${fieldData.name}</div>
                        <div class="field-price">‚Ç¨${fieldData.price}</div>
                    `;
                }
            }
            
            // Add click handler for property info
            field.addEventListener('click', () => showPropertyInfo(fieldData));
            
            return field;
        }

        function showPropertyInfo(fieldData) {
            if (fieldData.type !== 'property' && fieldData.type !== 'station' && fieldData.type !== 'utility') return;
            
            const card = document.getElementById('propertyCard');
            const header = document.getElementById('propertyCardHeader');
            const details = document.getElementById('propertyCardDetails');
            
            header.textContent = fieldData.name;
            if (fieldData.color) {
                header.className = 'property-card-header property-' + fieldData.color;
            } else {
                header.className = 'property-card-header';
                header.style.background = fieldData.type === 'station' ? '#34495e' : '#95a5a6';
            }
            
            let detailsHTML = `
                <div><strong>Preis:</strong> ‚Ç¨${fieldData.price}</div>
                <div><strong>Miete:</strong> ‚Ç¨${fieldData.rent}</div>
            `;
            
            const owner = gameState.properties[fieldData.position];
            if (owner !== undefined) {
                const player = gameState.players[owner];
                detailsHTML += `<div><strong>Besitzer:</strong> ${player.name}</div>`;
                
                if (fieldData.type === 'property') {
                    const houses = player.houses[fieldData.position] || 0;
                    if (houses > 0 && houses < 5) {
                        detailsHTML += `<div><strong>H√§user:</strong> ${houses}</div>`;
                    } else if (houses === 5) {
                        detailsHTML += `<div><strong>Hotel:</strong> ‚úì</div>`;
                    }
                }
            } else {
                detailsHTML += `<div><strong>Besitzer:</strong> Bank</div>`;
            }
            
            details.innerHTML = detailsHTML;
            card.classList.add('show');
            
            setTimeout(() => {
                card.classList.remove('show');
            }, 3000);
        }

        function showSetupModal() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('setupModal').classList.add('active');
            
            // Add color picker listeners
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const player = this.dataset.player;
                    document.querySelectorAll(`.color-option[data-player="${player}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        }

        function addPlayer() {
            if (gameState.playerCount >= 4) {
                alert('Maximal 4 Spieler m√∂glich!');
                return;
            }
            
            gameState.playerCount++;
            const container = document.getElementById('playerSetupContainer');
            const playerSetup = document.createElement('div');
            playerSetup.className = 'player-setup';
            playerSetup.innerHTML = `
                <h4>Spieler ${gameState.playerCount}</h4>
                <input type="text" placeholder="Name eingeben" id="player${gameState.playerCount}Name" value="Spieler ${gameState.playerCount}">
                <div class="color-picker">
                    <div class="color-option" style="background: #e74c3c" data-color="#e74c3c" data-player="${gameState.playerCount}"></div>
                    <div class="color-option" style="background: #3498db" data-color="#3498db" data-player="${gameState.playerCount}"></div>
                    <div class="color-option selected" style="background: #2ecc71" data-color="#2ecc71" data-player="${gameState.playerCount}"></div>
                    <div class="color-option" style="background: #f39c12" data-color="#f39c12" data-player="${gameState.playerCount}"></div>
                </div>
            `;
            container.appendChild(playerSetup);
            
            // Add color picker listener for new player
            playerSetup.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const player = this.dataset.player;
                    document.querySelectorAll(`.color-option[data-player="${player}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        }

        function startGame() {
            // Initialize players
            gameState.players = [];
            for (let i = 1; i <= gameState.playerCount; i++) {
                const nameInput = document.getElementById(`player${i}Name`);
                const colorOption = document.querySelector(`.color-option.selected[data-player="${i}"]`);
                
                gameState.players.push({
                    id: i - 1,
                    name: nameInput ? nameInput.value : `Spieler ${i}`,
                    money: 1500,
                    position: 0,
                    properties: [],
                    houses: {},
                    inJail: false,
                    jailTurns: 0,
                    color: colorOption ? colorOption.dataset.color : '#' + Math.floor(Math.random()*16777215).toString(16)
                });
            }
            
            // Hide setup modal and show game
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('gameContainer').style.display = 'block';
            
            // Initialize board and game
            initializeBoard();
            updatePlayerInfo();
            addPlayerPieces();
            addToLog('Spiel gestartet! ' + gameState.players[0].name + ' ist am Zug.');
        }

        function addPlayerPieces() {
            gameState.players.forEach(player => {
                const piece = document.createElement('div');
                piece.className = 'player-piece';
                piece.id = `player-${player.id}`;
                piece.style.background = player.color;
                document.getElementById('board').appendChild(piece);
                updatePlayerPosition(player);
            });
        }

        function updatePlayerPosition(player) {
            const piece = document.getElementById(`player-${player.id}`);
            const field = document.querySelector(`[data-position="${player.position}"]`);
            
            if (field && piece) {
                const rect = field.getBoundingClientRect();
                const boardRect = document.getElementById('board').getBoundingClientRect();
                
                const offsetX = 10 + (player.id * 15); // Offset for multiple players
                const offsetY = 10;
                
                piece.style.left = (rect.left - boardRect.left + offsetX) + 'px';
                piece.style.top = (rect.top - boardRect.top + offsetY) + 'px';
            }
        }

        function rollDice() {
            if (gameState.hasRolled) return;
            
            const die1 = document.getElementById('die1');
            const die2 = document.getElementById('die2');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Check if in jail
            if (currentPlayer.inJail) {
                gameState.diceValues[0] = Math.floor(Math.random() * 6) + 1;
                gameState.diceValues[1] = Math.floor(Math.random() * 6) + 1;
                
                animateDice(die1, die2);
                
                if (gameState.diceValues[0] === gameState.diceValues[1]) {
                    currentPlayer.inJail = false;
                    currentPlayer.jailTurns = 0;
                    addToLog(currentPlayer.name + ' w√ºrfelt einen Pasch und kommt aus dem Gef√§ngnis frei!');
                    movePlayer(gameState.diceValues[0] + gameState.diceValues[1]);
                } else {
                    currentPlayer.jailTurns++;
                    if (currentPlayer.jailTurns >= 3) {
                        currentPlayer.money -= 50;
                        currentPlayer.inJail = false;
                        currentPlayer.jailTurns = 0;
                        addToLog(currentPlayer.name + ' muss ‚Ç¨50 zahlen und kommt aus dem Gef√§ngnis.');
                        movePlayer(gameState.diceValues[0] + gameState.diceValues[1]);
                    } else {
                        addToLog(currentPlayer.name + ' bleibt im Gef√§ngnis. Noch ' + (3 - currentPlayer.jailTurns) + ' Versuche.');
                        gameState.hasRolled = true;
                        document.getElementById('endTurnButton').disabled = false;
                    }
                }
            } else {
                gameState.diceValues[0] = Math.floor(Math.random() * 6) + 1;
                gameState.diceValues[1] = Math.floor(Math.random() * 6) + 1;
                
                animateDice(die1, die2);
                
                const total = gameState.diceValues[0] + gameState.diceValues[1];
                addToLog(currentPlayer.name + ' w√ºrfelt ' + total);
                movePlayer(total);
            }
            
            gameState.hasRolled = true;
            document.getElementById('rollButton').disabled = true;
            updatePlayerInfo();
        }

        function animateDice(die1, die2) {
            const diceSymbols = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            
            die1.classList.add('rolling');
            die2.classList.add('rolling');
            
            setTimeout(() => {
                die1.textContent = diceSymbols[gameState.diceValues[0] - 1];
                die2.textContent = diceSymbols[gameState.diceValues[1] - 1];
                die1.classList.remove('rolling');
                die2.classList.remove('rolling');
            }, 500);
        }

        function movePlayer(steps) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const oldPosition = currentPlayer.position;
            
            currentPlayer.position = (currentPlayer.position + steps) % 40;
            
            // Check if passed START
            if (currentPlayer.position < oldPosition && steps > 0) {
                currentPlayer.money += 200;
                addToLog(currentPlayer.name + ' passiert START und erh√§lt ‚Ç¨200!');
            }
            
            updatePlayerPosition(currentPlayer);
            
            // Handle landing on field
            setTimeout(() => handleFieldAction(), 600);
        }

        function handleFieldAction() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const field = boardFields[currentPlayer.position];
            
            switch (field.type) {
                case 'property':
                case 'station':
                case 'utility':
                    handlePropertyLanding(field);
                    break;
                case 'chance':
                    handleChanceCard();
                    break;
                case 'community':
                    handleCommunityCard();
                    break;
                case 'tax':
                    currentPlayer.money -= field.price;
                    addToLog(currentPlayer.name + ' zahlt ‚Ç¨' + field.price + ' Steuern.');
                    updatePlayerInfo();
                    document.getElementById('endTurnButton').disabled = false;
                    break;
                case 'corner':
                    if (currentPlayer.position === 30) { // Go to Jail
                        goToJail();
                    } else {
                        document.getElementById('endTurnButton').disabled = false;
                    }
                    break;
                default:
                    document.getElementById('endTurnButton').disabled = false;
            }
        }

        function handlePropertyLanding(field) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const owner = gameState.properties[field.position];
            
            if (owner === undefined) {
                // Property available for purchase
                if (currentPlayer.money >= field.price) {
                    document.getElementById('buyButton').style.display = 'inline-block';
                    gameState.currentProperty = field;
                } else {
                    addToLog(currentPlayer.name + ' hat nicht genug Geld f√ºr ' + field.name);
                    document.getElementById('endTurnButton').disabled = false;
                }
            } else if (owner === currentPlayer.id) {
                addToLog(currentPlayer.name + ' landet auf eigenem Grundst√ºck.');
                document.getElementById('endTurnButton').disabled = false;
            } else {
                // Pay rent
                const rent = calculateRent(field, owner);
                currentPlayer.money -= rent;
                gameState.players[owner].money += rent;
                addToLog(currentPlayer.name + ' zahlt ‚Ç¨' + rent + ' Miete an ' + gameState.players[owner].name);
                updatePlayerInfo();
                document.getElementById('endTurnButton').disabled = false;
            }
        }

        function calculateRent(field, ownerId) {
            const owner = gameState.players[ownerId];
            let baseRent = field.rent;
            
            if (field.type === 'property') {
                const houses = owner.houses[field.position] || 0;
                if (houses === 1) baseRent *= 5;
                else if (houses === 2) baseRent *= 15;
                else if (houses === 3) baseRent *= 45;
                else if (houses === 4) baseRent *= 80;
                else if (houses === 5) baseRent *= 120; // Hotel
                
                // Check for monopoly
                if (hasMonopoly(ownerId, field.color) && houses === 0) {
                    baseRent *= 2;
                }
            } else if (field.type === 'station') {
                const stationCount = owner.properties.filter(p => 
                    boardFields[p].type === 'station'
                ).length;
                baseRent = 25 * Math.pow(2, stationCount - 1);
            } else if (field.type === 'utility') {
                const utilityCount = owner.properties.filter(p => 
                    boardFields[p].type === 'utility'
                ).length;
                const diceTotal = gameState.diceValues[0] + gameState.diceValues[1];
                baseRent = diceTotal * (utilityCount === 1 ? 4 : 10);
            }
            
            return baseRent;
        }

        function hasMonopoly(playerId, color) {
            const player = gameState.players[playerId];
            const colorProperties = boardFields.filter(f => 
                f.type === 'property' && f.color === color
            );
            
            return colorProperties.every(prop => 
                gameState.properties[prop.position] === playerId
            );
        }

        function showBuyPropertyModal() {
            const modal = document.getElementById('buyModal');
            const info = document.getElementById('buyPropertyInfo');
            const field = gameState.currentProperty;
            
            info.innerHTML = `
                <h3>${field.name}</h3>
                <p>Preis: ‚Ç¨${field.price}</p>
                <p>Basismiete: ‚Ç¨${field.rent}</p>
                <p>Dein Geld: ‚Ç¨${gameState.players[gameState.currentPlayerIndex].money}</p>
            `;
            
            modal.classList.add('active');
        }

        function buyProperty() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const field = gameState.currentProperty;
            
            currentPlayer.money -= field.price;
            currentPlayer.properties.push(field.position);
            gameState.properties[field.position] = currentPlayer.id;
            
            addToLog(currentPlayer.name + ' kauft ' + field.name + ' f√ºr ‚Ç¨' + field.price);
            
            closeBuyModal();
            updatePlayerInfo();
            document.getElementById('endTurnButton').disabled = false;
        }

        function closeBuyModal() {
            document.getElementById('buyModal').classList.remove('active');
            document.getElementById('buyButton').style.display = 'none';
            document.getElementById('endTurnButton').disabled = false;
        }

        function handleChanceCard() {
            const card = chanceCards[Math.floor(Math.random() * chanceCards.length)];
            showCard('Ereigniskarte', card);
        }

        function handleCommunityCard() {
            const card = communityCards[Math.floor(Math.random() * communityCards.length)];
            showCard('Gemeinschaftskarte', card);
        }

        function showCard(title, card) {
            document.getElementById('cardTitle').textContent = title;
            document.getElementById('cardText').textContent = card.text;
            document.getElementById('cardModal').classList.add('active');
            
            executeCardAction(card);
        }

        function executeCardAction(card) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            switch (card.action) {
                case 'money':
                    currentPlayer.money += card.amount;
                    break;
                case 'move':
                    const oldPos = currentPlayer.position;
                    currentPlayer.position = card.target;
                    if (card.target === 0 || (card.target < oldPos && card.target !== 30)) {
                        currentPlayer.money += 200;
                        addToLog(currentPlayer.name + ' passiert START und erh√§lt ‚Ç¨200!');
                    }
                    updatePlayerPosition(currentPlayer);
                    setTimeout(() => handleFieldAction(), 600);
                    return;
                case 'moveRelative':
                    movePlayer(card.amount);
                    return;
                case 'jail':
                    goToJail();
                    return;
                case 'birthday':
                    gameState.players.forEach((player, index) => {
                        if (index !== gameState.currentPlayerIndex) {
                            player.money -= 10;
                            currentPlayer.money += 10;
                        }
                    });
                    break;
                case 'repairs':
                    let repairCost = 0;
                    for (let pos in currentPlayer.houses) {
                        const houses = currentPlayer.houses[pos];
                        if (houses < 5) {
                            repairCost += houses * 25;
                        } else {
                            repairCost += 100;
                        }
                    }
                    currentPlayer.money -= repairCost;
                    if (repairCost > 0) {
                        addToLog(currentPlayer.name + ' zahlt ‚Ç¨' + repairCost + ' f√ºr Reparaturen.');
                    }
                    break;
            }
            
            updatePlayerInfo();
        }

        function closeCardModal() {
            document.getElementById('cardModal').classList.remove('active');
            document.getElementById('endTurnButton').disabled = false;
        }

        function goToJail() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            currentPlayer.position = 10;
            currentPlayer.inJail = true;
            currentPlayer.jailTurns = 0;
            updatePlayerPosition(currentPlayer);
            addToLog(currentPlayer.name + ' geht ins Gef√§ngnis!');
            document.getElementById('endTurnButton').disabled = false;
        }

        function showPropertiesModal() {
            const modal = document.getElementById('propertiesModal');
            const list = document.getElementById('propertiesList');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            if (currentPlayer.properties.length === 0) {
                list.innerHTML = '<p>Du besitzt noch keine Grundst√ºcke.</p>';
            } else {
                list.innerHTML = '<div class="property-list">';
                currentPlayer.properties.forEach(pos => {
                    const field = boardFields[pos];
                    const houses = currentPlayer.houses[pos] || 0;
                    let houseText = '';
                    if (houses > 0 && houses < 5) {
                        houseText = ` - ${houses} Haus/H√§user`;
                    } else if (houses === 5) {
                        houseText = ' - Hotel';
                    }
                    
                    list.innerHTML += `
                        <div class="property-item">
                            <span>${field.name}${houseText}</span>
                            <span>Wert: ‚Ç¨${field.price}</span>
                        </div>
                    `;
                });
                list.innerHTML += '</div>';
            }
            
            modal.classList.add('active');
        }

        function closePropertiesModal() {
            document.getElementById('propertiesModal').classList.remove('active');
        }

        function showTradeModal() {
            const modal = document.getElementById('tradeModal');
            const partnerSelect = document.getElementById('tradePartner');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Reset selections
            gameState.selectedTradeProperties = { yours: [], theirs: [] };
            
            // Populate partner select
            partnerSelect.innerHTML = '';
            gameState.players.forEach((player, index) => {
                if (index !== gameState.currentPlayerIndex) {
                    partnerSelect.innerHTML += `<option value="${index}">${player.name}</option>`;
                }
            });
            
            // Update property lists
            updateTradeProperties();
            
            modal.classList.add('active');
        }

        function updateTradeProperties() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const partnerIndex = parseInt(document.getElementById('tradePartner').value);
            const partner = gameState.players[partnerIndex];
            
            const yourProps = document.getElementById('yourProperties');
            const theirProps = document.getElementById('theirProperties');
            
            // Your properties
            yourProps.innerHTML = '<div class="property-list">';
            if (currentPlayer.properties.length === 0) {
                yourProps.innerHTML += '<p>Keine Grundst√ºcke</p>';
            } else {
                currentPlayer.properties.forEach(pos => {
                    const field = boardFields[pos];
                    yourProps.innerHTML += `
                        <div class="property-item" onclick="toggleTradeProperty(${pos}, true)">
                            <span>${field.name}</span>
                            <span>‚Ç¨${field.price}</span>
                        </div>
                    `;
                });
            }
            yourProps.innerHTML += '</div>';
            
            // Their properties
            theirProps.innerHTML = '<div class="property-list">';
            if (partner && partner.properties.length > 0) {
                partner.properties.forEach(pos => {
                    const field = boardFields[pos];
                    theirProps.innerHTML += `
                        <div class="property-item" onclick="toggleTradeProperty(${pos}, false)">
                            <span>${field.name}</span>
                            <span>‚Ç¨${field.price}</span>
                        </div>
                    `;
                });
            } else {
                theirProps.innerHTML += '<p>Keine Grundst√ºcke</p>';
            }
            theirProps.innerHTML += '</div>';
        }

        function toggleTradeProperty(position, isYours) {
            const array = isYours ? gameState.selectedTradeProperties.yours : gameState.selectedTradeProperties.theirs;
            const index = array.indexOf(position);
            
            if (index === -1) {
                array.push(position);
            } else {
                array.splice(index, 1);
            }
            
            // Update visual selection
            event.target.closest('.property-item').classList.toggle('selected');
        }

        function proposeTrade() {
            const partnerIndex = parseInt(document.getElementById('tradePartner').value);
            const partner = gameState.players[partnerIndex];
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            const yourMoney = parseInt(document.getElementById('yourMoney').value) || 0;
            const theirMoney = parseInt(document.getElementById('theirMoney').value) || 0;
            
            // Simulate trade acceptance (in real game, other player would decide)
            const accept = confirm(`${partner.name}, akzeptierst du diesen Handel?`);
            
            if (accept) {
                // Execute trade
                // Transfer properties from you to them
                gameState.selectedTradeProperties.yours.forEach(pos => {
                    const index = currentPlayer.properties.indexOf(pos);
                    currentPlayer.properties.splice(index, 1);
                    partner.properties.push(pos);
                    gameState.properties[pos] = partnerIndex;
                });
                
                // Transfer properties from them to you
                gameState.selectedTradeProperties.theirs.forEach(pos => {
                    const index = partner.properties.indexOf(pos);
                    partner.properties.splice(index, 1);
                    currentPlayer.properties.push(pos);
                    gameState.properties[pos] = gameState.currentPlayerIndex;
                });
                
                // Transfer money
                currentPlayer.money -= yourMoney;
                currentPlayer.money += theirMoney;
                partner.money += yourMoney;
                partner.money -= theirMoney;
                
                addToLog(`Handel zwischen ${currentPlayer.name} und ${partner.name} abgeschlossen!`);
                updatePlayerInfo();
            } else {
                addToLog(`${partner.name} lehnt den Handel ab.`);
            }
            
            closeTradeModal();
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        // Add event listener for partner change
        document.getElementById('tradePartner').addEventListener('change', updateTradeProperties);

        function showBuildModal() {
            const modal = document.getElementById('buildModal');
            const list = document.getElementById('buildableProperties');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            list.innerHTML = '';
            
            // Find buildable properties (complete color groups)
            const buildable = [];
            const colors = ['brown', 'lightblue', 'pink', 'orange', 'red', 'yellow', 'green', 'blue'];
            
            colors.forEach(color => {
                if (hasMonopoly(currentPlayer.id, color)) {
                    const colorProps = boardFields.filter(f => 
                        f.type === 'property' && f.color === color && 
                        gameState.properties[f.position] === currentPlayer.id
                    );
                    buildable.push(...colorProps);
                }
            });
            
            if (buildable.length === 0) {
                list.innerHTML = '<p>Du musst erst alle Grundst√ºcke einer Farbe besitzen, um bauen zu k√∂nnen.</p>';
            } else {
                list.innerHTML = '<div class="property-list">';
                buildable.forEach(field => {
                    const houses = currentPlayer.houses[field.position] || 0;
                    const houseCost = Math.ceil(field.price / 2);
                    let buildText = '';
                    
                    if (houses < 4) {
                        buildText = `Haus bauen (‚Ç¨${houseCost})`;
                    } else if (houses === 4) {
                        buildText = `Hotel bauen (‚Ç¨${houseCost})`;
                    } else {
                        buildText = 'Vollst√§ndig ausgebaut';
                    }
                    
                    list.innerHTML += `
                        <div class="property-item">
                            <div>
                                <strong>${field.name}</strong><br>
                                H√§user: ${houses < 5 ? houses : 'Hotel'}
                            </div>
                            ${houses < 5 ? `<button onclick="buildHouse(${field.position})">${buildText}</button>` : '<span>Max</span>'}
                        </div>
                    `;
                });
                list.innerHTML += '</div>';
            }
            
            modal.classList.add('active');
        }

        function buildHouse(position) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const field = boardFields[position];
            const houseCost = Math.ceil(field.price / 2);
            
            if (currentPlayer.money < houseCost) {
                alert('Nicht genug Geld!');
                return;
            }
            
            if (!currentPlayer.houses[position]) {
                currentPlayer.houses[position] = 0;
            }
            
            if (currentPlayer.houses[position] < 5) {
                currentPlayer.houses[position]++;
                currentPlayer.money -= houseCost;
                
                // Update visual houses
                const housesContainer = document.getElementById(`houses-${position}`);
                if (housesContainer) {
                    housesContainer.innerHTML = '';
                    const houseCount = currentPlayer.houses[position];
                    
                    if (houseCount === 5) {
                        housesContainer.innerHTML = '<div class="hotel"></div>';
                        addToLog(currentPlayer.name + ' baut ein Hotel auf ' + field.name);
                    } else {
                        for (let i = 0; i < houseCount; i++) {
                            housesContainer.innerHTML += '<div class="house"></div>';
                        }
                        addToLog(currentPlayer.name + ' baut Haus ' + houseCount + ' auf ' + field.name);
                    }
                }
                
                updatePlayerInfo();
                showBuildModal(); // Refresh the modal
            }
        }

        function closeBuildModal() {
            document.getElementById('buildModal').classList.remove('active');
        }

        function endTurn() {
            // Check for bankruptcy
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (currentPlayer.money < 0) {
                addToLog(currentPlayer.name + ' ist bankrott!');
                gameState.players.splice(gameState.currentPlayerIndex, 1);
                
                // Check for winner
                if (gameState.players.length === 1) {
                    alert('üéâ ' + gameState.players[0].name + ' gewinnt das Spiel! üéâ');
                    location.reload();
                    return;
                }
            } else {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            }
            
            gameState.hasRolled = false;
            document.getElementById('rollButton').disabled = false;
            document.getElementById('endTurnButton').disabled = true;
            document.getElementById('buyButton').style.display = 'none';
            
            addToLog(gameState.players[gameState.currentPlayerIndex].name + ' ist am Zug.');
            updatePlayerInfo();
        }

        function updatePlayerInfo() {
            const container = document.getElementById('playerInfo');
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const isActive = index === gameState.currentPlayerIndex;
                const card = document.createElement('div');
                card.className = 'player-card' + (isActive ? ' active' : '');
                
                let status = '';
                if (player.inJail) {
                    status = ' üîí';
                }
                
                card.innerHTML = `
                    <h3>
                        <span class="player-token" style="background: ${player.color}"></span>
                        ${player.name}${status}
                    </h3>
                    <div>üí∞ ‚Ç¨${player.money}</div>
                    <div>üèòÔ∏è ${player.properties.length} Grundst√ºcke</div>
                `;
                
                container.appendChild(card);
            });
        }

        function addToLog(message) {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 10 entries
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        // Initialize on page load
        window.onload = function() {
            // Game will be initialized when user starts from setup
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            gameState.players.forEach(player => {
                updatePlayerPosition(player);
            });
        });
    </script>
</body>
</html>